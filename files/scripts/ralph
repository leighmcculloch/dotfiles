#!/bin/bash

GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

function log() {
  echo -e "${GREEN}$1${NC}"
}

if [ "$#" -lt 3 ]; then
  log "Usage: $0 <max_attempts> <search_text> <prompt>"
  exit 1
fi

if ! [[ "$1" =~ ^[0-9]+$ ]]; then
  log "Error: First argument <max_attempts> must be a positive integer. You provided: '$1'"
  log "Usage: $0 <max_attempts> <search_text> <prompt>"
  exit 1
fi

MAX_ATTEMPTS="$1"
SEARCH="$2"
PROMPT="$3"
COPILOT_CMD="copilot"

log "Running '$COPILOT_CMD' with prompt '$PROMPT' until stdout contains '$SEARCH' (Max attempts: $MAX_ATTEMPTS)"

count=0
while [ $count -lt $MAX_ATTEMPTS ]; do
  count=$((count + 1))
  
  log "----------------------------------------"
  log "--- Run #$count ---"
  log "----------------------------------------"
  
  # Create temp dir for logs
  LOG_DIR=$(mktemp -d)
  
  # Background tailer for logs - shows last 8 lines with screen rewriting
  (
    # Wait for file to appear (up to 2 seconds)
    for i in {1..20}; do
      shopt -s nullglob
      files=("$LOG_DIR"/*)
      if [ ${#files[@]} -gt 0 ]; then
        # Cache terminal width once
        cols=$(tput cols 2>/dev/null || echo 80)
        
        tail -n +1 -F "${files[@]}" 2>/dev/null | awk -v cols="$cols" -v cyan="$CYAN" -v nc="$NC" '
        BEGIN {
          bufsize = 8
          idx = 0
          count = 0
          printed = 0
        }
        {
          # Store line in ring buffer
          buf[idx] = substr($0, 1, cols)
          idx = (idx + 1) % bufsize
          if (count < bufsize) count++
          
          # Move cursor up to overwrite previous output
          if (printed > 0) {
            printf "\033[%dA", printed > "/dev/stderr"
          }
          
          # Print all buffered lines
          printed = count
          for (i = 0; i < count; i++) {
            line = buf[(idx - count + i + bufsize) % bufsize]
            printf "\033[2K%s%s%s\n", cyan, line, nc > "/dev/stderr"
          }
          fflush("/dev/stderr")
        }
        '
        break
      fi
      sleep 0.1
    done
  ) &
  TAILER_PID=$!
  
  # Run the command, capture stdout and stderr (but logs go to LOG_DIR)
  OUTPUT=$("$COPILOT_CMD" -p "$PROMPT" --log-dir "$LOG_DIR" --log-level all 2>&1)
  
  # Clean up tailer
  kill $TAILER_PID 2>/dev/null
  wait $TAILER_PID 2>/dev/null
  
  # Clear the log window (move up 8 lines and clear each)
  for i in {1..8}; do
    printf '\033[1A\033[2K' >&2
  done
  
  # Print the command output
  echo "$OUTPUT"
  
  # Clean up logs
  rm -rf "$LOG_DIR"
  
  # Check if search term matches
  if echo "$OUTPUT" | grep -Fq "$SEARCH"; then
    log "Found '$SEARCH'!"
    exit 0
  fi
  
  sleep 1
done

log "Max attempts ($MAX_ATTEMPTS) reached without finding '$SEARCH'."
exit 1
