#!/usr/bin/env zsh

set -o nounset
export SCRIPT=gbb

function {
  local branches="${${$(git branch --all --format='%(refname:short)' | jq -R -s '.')%\"}#\"}"

  local diff="$(git diff HEAD)"
  if [ -z "$diff" ]; then
    echo "No changes detected in working directory"
    return 1
  fi

  # Detect MDM enrollment
  local mdm_enrolled=0
  if profiles status -type enrollment 2>/dev/null | grep -q "Yes"; then
    mdm_enrolled=1
  fi

  local ai=""
  if (( mdm_enrolled )); then
    #ai="opencode run -m github-copilot/claude-opus-4.6"
    ai="claude --model claude-sonnet-4-6 --effort low -p"
  else
    ai="claude --model claude-sonnet-4-6 --effort low -p"
  fi

  printf "○ %s\n" "$ai"
  local start_time=$(gdate +%s%6N)
  local name="$(${=ai} -p "You are a senior software engineer.

Given the following git diff, suggest a concise, kebab-case branch name that describes the changes (max 5 words).

Reply only with the branch name, nothing else.

Do not use any of these names: ${branches}.

Diff:
${diff}" | tr '[:upper:] ' '[:lower:]-')"
  local end_time=$(gdate +%s%6N)
  local elapsed_us=$((end_time - start_time))
  local elapsed_s=$(printf '%d.%06d' $((elapsed_us / 1000000)) $((elapsed_us % 1000000)))
  printf "\033[1A● %s (${elapsed_s}s)\033[K\n" "$ai"

  if [ -z "$name" ]; then
    echo "Error: Failed to get branch name"
    return 1
  fi

  local name="$(gum input --width 50 --char-limit 50 --prompt '| ' --value "$name")"

  git checkout -b "$name" $@
}
