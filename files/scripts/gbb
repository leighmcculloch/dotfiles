#!/usr/bin/env zsh

set -o nounset

function {
  local branches="${${$(git branch --all --format='%(refname:short)' | jq -R -s '.')%\"}#\"}"

  local diff="$(git diff HEAD)"
  if [ -z "$diff" ]; then
    echo "No changes detected in working directory"
    return 1
  fi

  local ai="${AI_CMD:-ai}"
  local name="$($ai -p "You are a senior software engineer.

Given the following git diff, suggest a concise, kebab-case branch name that describes the changes (max 5 words).

Reply only with the branch name, nothing else.

Do not use any of these names: ${branches}.

Diff:
${diff}" | tr '[:upper:] ' '[:lower:]-')"

  if [ -z "$name" ]; then
    echo "Error: Failed to get branch name"
    return 1
  fi

  local name="$(gum input --width 50 --char-limit 50 --prompt '| ' --value "$name")"

  git checkout -b "$name" $@
}
